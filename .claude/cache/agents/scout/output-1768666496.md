# Codebase Report: Session List and Kill Functionality
Generated: 2026-01-17

## Summary
Found the homepage session list component and the complete kill session workflow. The kill functionality EXISTS on the backend but is NOT EXPOSED in the UI. The homepage shows session cards in a scrollable list but there's no delete/kill button or swipe gesture.

## Project Structure
```
ter/
  app/
    index.tsx           # Homepage with session list
    _layout.tsx         # App routes
    session/[hostId]/[name]/terminal.tsx  # Session detail pages
  lib/
    api.ts              # API client with killSession()
    live.ts             # WebSocket live updates
    store.ts            # Host management
    types.ts            # TypeScript types
  agent/
    server.ts           # Backend API server (Hono)
    tmux.ts             # tmux command wrappers
    sessions.ts         # Session management
  components/
    LaunchSheet.tsx     # Create new session UI
    PortRow.tsx         # Port manager with kill button (reference example)
    GlassCard.tsx       # Reusable card component
```

## Questions Answered

### Q1: Where is the homepage session list component?
**Location:** `/home/gabrielolv/Documents/Projects/ter/app/index.tsx`
**Component:** `HomeScreen` (default export)
**Entry Point:** Lines 236-294 - sessions are mapped into Pressable cards

**Key Code:**
```typescript
{group.sessions.map((session, index) => {
  return (
    <Pressable
      key={session.name}
      onPress={() => router.push(`/session/${group.host.id}/${encodeURIComponent(session.name)}/terminal`)}
      style={({ pressed }) => [styles.sessionPressable, pressed && styles.sessionCardPressed]}
    >
      <GlassCard style={styles.sessionCard}>
        <View style={styles.sessionHeader}>
          {/* Session name, state badge, git branch, etc. */}
        </View>
      </GlassCard>
    </Pressable>
  );
})}
```

**What it shows:**
- Session name
- Agent state (running/idle/stopped) with colored badge
- Git branch (if available)
- Agent command (if available)
- Host color indicator
- Attached status

**What's MISSING:**
- No kill/delete button
- No swipe-to-delete gesture
- No context menu or long-press actions

### Q2: How does the kill session API work?

**Frontend API:** `/home/gabrielolv/Documents/Projects/ter/lib/api.ts` (lines 81-85)
```typescript
export async function killSession(host: Host, name: string): Promise<void> {
  await request(host, `/sessions/${encodeURIComponent(name)}/kill`, {
    method: 'POST',
  });
}
```

**Backend Endpoint:** `/home/gabrielolv/Documents/Projects/ter/agent/server.ts` (lines 369-378)
```typescript
app.post('/sessions/:name/kill', async (c) => {
  try {
    const name = requireName(c.req.param('name'));
    await runTmux(['kill-session', '-t', name]);
    return c.json({ ok: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err);
    return c.json({ error: message }, 400);
  }
});
```

**Backend Implementation:** Calls `tmux kill-session -t <name>`

**Status:** ✓ VERIFIED - Backend fully implemented and working

### Q3: Where is kill functionality used (if anywhere)?

**Search Results:**
- `/home/gabrielolv/Documents/Projects/ter/lib/api.ts` - `killSession()` exported but NOT imported in homepage
- `/home/gabrielolv/Documents/Projects/ter/app/index.tsx` - Only imports `createSession`, NOT `killSession`

**Import in homepage:**
```typescript
import { createSession } from '@/lib/api';  // ← ONLY createSession
```

**Status:** ? INFERRED - Function exists but is not used anywhere in the UI

### Q4: Is there a reference implementation for delete/kill UI?

**Yes!** `/home/gabrielolv/Documents/Projects/ter/components/PortRow.tsx` (lines 48-51)

```tsx
<Pressable style={styles.killButton} onPress={onKill}>
  <AppText variant="label" style={styles.killText}>
    Kill
  </AppText>
</Pressable>
```

This component shows how to add a kill button with proper styling that matches the app theme.

## Architecture Map

### Session Management Flow
```
[Homepage]
    |
    | displays sessions from
    |
[useHostsLive hook] ← WebSocket updates
    |
    | fetches from
    |
[Agent Server] (:8082)
    |
    | reads/writes
    |
[tmux]
```

### Kill Session Flow (POTENTIAL)
```
[Homepage UI]
    |
    | user taps kill button (NOT IMPLEMENTED)
    |
[killSession(host, name)]  ← lib/api.ts
    |
    | POST /sessions/:name/kill
    |
[Agent Server]
    |
    | tmux kill-session -t name
    |
[tmux]
    |
[WebSocket broadcasts update]
    |
[Homepage refreshes] ← session removed from list
```

## Key Files

| File | Purpose | Key Functions |
|------|---------|---------------|
| `/home/gabrielolv/Documents/Projects/ter/app/index.tsx` | Homepage component | `HomeScreen()` - renders session list |
| `/home/gabrielolv/Documents/Projects/ter/lib/api.ts` | API client | `killSession(host, name)` - lines 81-85 |
| `/home/gabrielolv/Documents/Projects/ter/agent/server.ts` | Backend server | `POST /sessions/:name/kill` - lines 369-378 |
| `/home/gabrielolv/Documents/Projects/ter/components/PortRow.tsx` | Reference UI | Kill button implementation - lines 48-51 |
| `/home/gabrielolv/Documents/Projects/ter/lib/live.ts` | Live updates | `useHostsLive()` hook for real-time session sync |

## Conventions Discovered

### Naming
- Files: kebab-case (`session-list.tsx` style not used, prefer `index.tsx` in route folders)
- Components: PascalCase (`HomeScreen`, `GlassCard`)
- Functions: camelCase (`killSession`, `createSession`)
- Styles: camelCase object keys (`sessionCard`, `sessionPressable`)

### UI Patterns
- **GlassCard**: Reusable glassmorphism card component with blur effect
- **Pressable**: Used for interactive elements with press states
- **FadeIn**: Animation wrapper for list items
- **AppText**: Themed text component with variants (subtitle, label, mono)

### API Patterns
| Pattern | Example |
|---------|---------|
| Create | `POST /sessions` with body `{ name: string }` |
| Delete | `POST /sessions/:name/kill` (not DELETE verb) |
| Rename | `POST /sessions/:name/rename` with body `{ newName: string }` |
| Action | `POST /sessions/:name/keys` with body `{ text: string }` |

**Note:** Uses POST for all mutations, not REST DELETE verb

### State Management
- `useStore()` - Global host configuration (Zustand)
- `useHostsLive()` - Real-time session state via WebSocket
- `useState()` - Local UI state (modals, forms, loading)

## Testing

**Test Files:** None found for session list component

**Manual Test Flow:**
1. Start agent: `cd agent && npm start`
2. Open app on device/simulator
3. Sessions should appear in list
4. Tap session → navigates to terminal
5. Kill button would need to be added for testing

## Open Questions

1. **Why is killSession not exposed in UI?**
   - Backend is fully implemented
   - API client function exists
   - No UI button or gesture to trigger it
   - Intentional omission or incomplete feature?

2. **Should kill use swipe gesture or button?**
   - `react-native-gesture-handler` is installed (v2.30.0)
   - Could use Swipeable component for iOS-style swipe-to-delete
   - Or add button like PortRow component does
   - Need design decision

3. **Should there be confirmation?**
   - Killing a session is destructive
   - Should show Alert.alert() for confirmation?
   - PortRow doesn't show confirmation before killing ports

4. **How to handle kill errors?**
   - Backend returns `{ error: string }` on failure
   - Should show Alert.alert() with error message
   - Should the session stay in list if kill fails?

## Implementation Notes

To add kill functionality to homepage:

1. **Import killSession:**
   ```typescript
   import { createSession, killSession } from '@/lib/api';
   ```

2. **Add handler:**
   ```typescript
   const handleKillSession = async (host: Host, sessionName: string) => {
     try {
       await killSession(host, sessionName);
       // Refresh handled automatically by WebSocket
     } catch (err) {
       Alert.alert('Failed to kill session', err instanceof Error ? err.message : 'Unknown error');
     }
   };
   ```

3. **Add UI (Option A - Button):**
   ```tsx
   <Pressable 
     style={styles.killButton} 
     onPress={(e) => {
       e.stopPropagation(); // Prevent navigation
       handleKillSession(session.host, session.name);
     }}
   >
     <AppText variant="label" style={styles.killText}>×</AppText>
   </Pressable>
   ```

4. **Add UI (Option B - Swipeable):**
   ```tsx
   import { Swipeable } from 'react-native-gesture-handler';
   
   <Swipeable
     renderRightActions={() => (
       <View style={styles.deleteAction}>
         <AppText>Delete</AppText>
       </View>
     )}
     onSwipeableOpen={() => handleKillSession(session.host, session.name)}
   >
     {/* Existing session card */}
   </Swipeable>
   ```

## Related Components

- **LaunchSheet** (`/home/gabrielolv/Documents/Projects/ter/components/LaunchSheet.tsx`) - Create session UI
- **PortRow** (`/home/gabrielolv/Documents/Projects/ter/components/PortRow.tsx`) - Kill button reference
- **HostCard** - Similar card-based list pattern

## Dependencies

- `react-native-gesture-handler` (v2.30.0) - Available for swipe gestures
- `lucide-react-native` - Icons (currently using GitBranch, Play, Pause, StopCircle)
- `@hono/node-server` - Backend HTTP server
- `ws` - WebSocket server for live updates
