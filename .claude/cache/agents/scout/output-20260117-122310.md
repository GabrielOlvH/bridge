# Codebase Report: Agent State Tracking & Detection
Generated: 2026-01-17 12:25:00

## Summary
The project has a comprehensive agent state detection system that tracks whether Claude/Codex agents are running, idle, or stopped in tmux sessions. State is determined by monitoring process activity and terminal output changes. The system uses React Query polling (15s intervals) to fetch session insights from the backend, which includes agent state metadata.

## Project Structure
```
ter/
├── agent/
│   ├── agents.ts         # Core agent detection & state logic
│   ├── state.ts          # Shared state (sessionActivity cache)
│   ├── config.ts         # Configuration (IDLE_STOP_MS = 2000ms)
│   ├── server.ts         # HTTP API server (Hono)
│   └── tmux.ts           # Tmux interaction utilities
├── app/
│   ├── index.tsx         # Home screen with session list (polls every 15s)
│   └── session/[...]/    # Session detail screens
├── lib/
│   └── types.ts          # TypeScript type definitions
└── components/
    └── (UI components - no existing alert/banner components)
```

## Questions Answered

### Q1: Where is agentState defined and used?

**Type Definition:**
- `/home/gabrielolv/Documents/Projects/ter/lib/types.ts:95` - Part of `InsightsMeta` type
- `/home/gabrielolv/Documents/Projects/ter/agent/state.ts:37` - Part of `UsageMeta` type

**Type Definition:**
```typescript
export type InsightsMeta = {
  lastPolled?: number;
  lastAttempt?: number;
  refreshing?: boolean;
  error?: string;
  activeAgent?: 'codex' | 'claude' | null;
  agentState?: 'running' | 'idle' | 'stopped';  // ← State definition
  agentCommand?: string | null;
};
```

**Usage Locations:**
1. `/home/gabrielolv/Documents/Projects/ter/agent/agents.ts:162` - Computed via `detectAgentState()`
2. `/home/gabrielolv/Documents/Projects/ter/agent/agents.ts:169` - Returned in `getSessionInsights()` meta
3. `/home/gabrielolv/Documents/Projects/ter/app/index.tsx:371-377` - Rendered in session list UI

**UI Implementation (Home Screen):**
```typescript
// app/index.tsx:371-377
const agentState = session.insights?.meta?.agentState ?? 'stopped';
const stateLabel = agentState === 'running' ? 'Running' 
                 : agentState === 'idle' ? 'Idle' 
                 : 'Stopped';
const stateTone = agentState === 'running' ? 'accent' 
                : agentState === 'idle' ? 'clay' 
                : 'muted';
```

### Q2: How does detectAgentState function work?

**Location:** `/home/gabrielolv/Documents/Projects/ter/agent/agents.ts:139-155`

**Algorithm:**
```typescript
function detectAgentState(
  sessionName: string,
  lines: string[] | null | undefined,
  processActive: boolean,
  idleWindowMs: number = IDLE_STOP_MS  // Default: 2000ms
): 'running' | 'idle' | 'stopped'
```

**Logic Flow:**
1. **If no process active** → `'stopped'`
2. **Hash terminal preview lines** → Create stable hash from ANSI-stripped output
3. **Compare with cached hash** → Check `sessionActivity` Map for previous state
4. **If output changed** → Update cache, return `'running'`
5. **If output unchanged** → Check elapsed time since last change
   - If elapsed > `IDLE_STOP_MS` (2000ms) → `'idle'`
   - Else → `'running'`

**Dependencies:**
- `stablePreviewHash(lines)` - Creates hash from ANSI-stripped terminal lines
- `sessionActivity` Map - Caches `{ hash, lastChangedAt }` per session
- `IDLE_STOP_MS` config - Idle threshold (default 2s, env: `TMUX_AGENT_IDLE_STOP_MS`)

**State Cache:**
```typescript
// agent/state.ts:116
export const sessionActivity: Map<
  string,  // session name
  { hash: string; lastChangedAt: number }
> = new Map();
```

### Q3: Where are session insights fetched/polled?

**Backend API:**
- `/home/gabrielolv/Documents/Projects/ter/agent/server.ts:196-198`
- Route: `GET /sessions?preview=true&previewLines=6&insights=true`

**Backend Logic:**
```typescript
// agent/server.ts:196
const sessionInsights = await getSessionInsights(session.name, previewLines);
const meta = sessionInsights.meta || usage.meta;
insights = { ...usage, ...sessionInsights, meta };
```

**`getSessionInsights()` Implementation:**
```typescript
// agent/agents.ts:157-173
export async function getSessionInsights(name: string, preview?: string[]) {
  const usage = await getUsageSnapshot();           // Token usage from providers
  const agentInfo = await getSessionAgentInfo(name);// Detect agent via tmux/ps
  const git = await getGitStatus(agentInfo.cwd);    // Git status from CWD
  const previewLines = preview ?? (await capturePane(name, 4));
  const agentState = detectAgentState(name, previewLines, agentInfo.processActive);
  
  return {
    ...usage,
    git,
    meta: {
      ...(usage.meta || {}),
      activeAgent: agentInfo.agent,      // 'codex' | 'claude' | null
      agentState,                        // 'running' | 'idle' | 'stopped'
      agentCommand: agentInfo.command,   // e.g., "claude"
    },
  };
}
```

**Frontend Polling (React Query):**
- `/home/gabrielolv/Documents/Projects/ter/app/index.tsx:39-72`

**Polling Configuration:**
```typescript
// app/index.tsx:39
const { data: queryData, refetch: refetchSessions } = useQuery({
  queryKey: ['home-sessions', hosts.map((h) => h.id).join(',')],
  queryFn: async () => {
    const hostSessions = await getSessions(host, { 
      preview: true, 
      previewLines: 6, 
      insights: true   // ← Fetches agent state
    });
    return { sessions: allSessions, statusMap };
  },
  enabled: ready && hosts.length > 0,
  staleTime: 15_000,        // Consider stale after 15s
  refetchInterval: 15_000,  // Poll every 15s
});
```

**Other Polling Locations:**
1. `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/index.tsx:61` - 20s interval
2. `/home/gabrielolv/Documents/Projects/ter/app/session/[hostId]/[name]/index.tsx:42` - 20s interval

### Q4: Agent Detection (getSessionAgentInfo)

**Location:** `/home/gabrielolv/Documents/Projects/ter/agent/agents.ts:65-132`

**Detection Methods:**

1. **Tmux pane inspection** - Query pane metadata:
   ```bash
   tmux list-panes -t <session> -F '#{pane_current_command}||#{pane_start_command}||#{pane_pid}||#{pane_current_path}'
   ```

2. **Process name matching** - Check for "claude" or "codex" in:
   - `pane_current_command`
   - `pane_start_command`
   - Session name

3. **PID-based detection** - Inspect process tree:
   ```bash
   ps -o args= -p <pid>      # Parent process
   pgrep -P <pid>            # Child processes
   ```

4. **Active process check** - Determine if non-shell process is running:
   - Shell commands: bash, zsh, fish, sh, tmux
   - If only shell → `processActive = false`
   - If non-shell child exists → `processActive = true`

**Return Type:**
```typescript
{
  agent: 'codex' | 'claude' | null,
  command: string | null,           // e.g., "claude"
  cwd: string | null,               // Working directory
  processActive: boolean            // Has non-shell process
}
```

## Agent State Flow Diagram

```
[tmux Session] 
    ↓
getSessionAgentInfo()
    ├─→ tmux list-panes        (get command, pid, cwd)
    ├─→ ps -o args= -p <pid>   (detect agent in parent)
    ├─→ pgrep -P <pid>         (detect agent in children)
    └─→ hasActiveProcess()     (check if non-shell running)
    ↓
{ agent, command, cwd, processActive }
    ↓
detectAgentState(sessionName, previewLines, processActive)
    ├─→ processActive = false? → 'stopped'
    ├─→ stablePreviewHash()    (hash terminal output)
    ├─→ Compare with sessionActivity cache
    ├─→ Output changed? → 'running'
    └─→ Elapsed > 2s? → 'idle' : 'running'
    ↓
'running' | 'idle' | 'stopped'
    ↓
getSessionInsights()
    ├─→ Combine with usage, git status
    └─→ Return SessionInsights with meta.agentState
    ↓
[Backend API] /sessions?insights=true
    ↓
[Frontend] React Query polling (15s)
    ↓
[UI] Display state badge in session list
```

## Configuration Constants

| Constant | Value | Environment Variable | Purpose |
|----------|-------|---------------------|---------|
| `IDLE_STOP_MS` | 2000ms | `TMUX_AGENT_IDLE_STOP_MS` | Idle detection threshold |
| `USAGE_POLL_INTERVAL` | 60000ms | `TMUX_AGENT_USAGE_POLL_MS` | Backend usage polling |
| `staleTime` | 15000ms | (frontend) | React Query cache duration |
| `refetchInterval` | 15000ms | (frontend) | React Query polling interval |

**File:** `/home/gabrielolv/Documents/Projects/ter/agent/config.ts`

## Key Files

| File | Purpose | Key Exports |
|------|---------|-------------|
| `agent/agents.ts` | Agent detection & state | `getSessionAgentInfo()`, `detectAgentState()`, `getSessionInsights()` |
| `agent/state.ts` | Shared state cache | `sessionActivity` Map, type definitions |
| `agent/config.ts` | Environment config | `IDLE_STOP_MS`, `USAGE_POLL_INTERVAL` |
| `agent/server.ts` | HTTP API (Hono) | `GET /sessions` with insights |
| `app/index.tsx` | Home screen | Session list with state polling (15s) |
| `lib/types.ts` | Type definitions | `InsightsMeta`, `SessionInsights` |

## State Values & UI Mapping

| State | Condition | UI Label | UI Tone | Badge Color |
|-------|-----------|----------|---------|-------------|
| `'stopped'` | `processActive = false` | "Stopped" | `'muted'` | Gray |
| `'idle'` | No output change > 2s | "Idle" | `'clay'` | Orange/Clay |
| `'running'` | Output changing or recent change | "Running" | `'accent'` | Blue/Accent |

**UI Code:**
```typescript
// app/index.tsx:371-373
const agentState = session.insights?.meta?.agentState ?? 'stopped';
const stateLabel = agentState === 'running' ? 'Running' 
                 : agentState === 'idle' ? 'Idle' 
                 : 'Stopped';
const stateTone = agentState === 'running' ? 'accent' 
                : agentState === 'idle' ? 'clay' 
                : 'muted';
```

## Notification/Alert Infrastructure

**Current State:** ✗ No alert/banner components found

**Existing UI Components:**
- `components/GlassCard.tsx` - Glass morphism cards
- `components/Pill.tsx` - Badge/pill component
- `components/AppText.tsx` - Text component with variants
- `components/FadeIn.tsx` - Animation wrapper

**Missing for Notifications:**
- No Banner component
- No Alert component
- No Toast component
- No expo-notifications package (see `.claude/cache/agents/scout/output-20260117-121943.md`)

**Existing Pattern for State Display:**
The app currently uses inline `<Pill>` components within session cards to show agent state. There's no top-level notification/alert system.

## Data Flow Summary

```
[Backend - Every Request]
  getSessionAgentInfo(name)
    → Detect agent via tmux/ps
  detectAgentState(name, preview, processActive)
    → Compare output hash with cache
    → Determine running/idle/stopped
  getSessionInsights(name, preview)
    → Combine agent state + usage + git
    → Return SessionInsights

[Frontend - Every 15s]
  React Query polling
    → GET /sessions?insights=true
    → Update state in React Query cache
  UI re-renders
    → Extract agentState from session.insights.meta
    → Display badge with label/color
```

## Open Questions

**Q:** Should state changes trigger notifications immediately, or only during polling intervals?
- Current: Polling-based only (15s delay max)
- Option: WebSocket for real-time state changes

**Q:** Should notifications be local (in-app banners) or push notifications (expo-notifications)?
- Current: No notification system exists
- Would need expo-notifications package + permission setup

**Q:** Should there be persistent notification state tracking to avoid duplicate alerts?
- Would need: `lastNotifiedState` cache per session

## Next Steps for Notification Implementation

1. **Create Banner Component** - Top-level alert/notification UI
2. **Add State Change Detection** - Compare previous vs current agentState
3. **Implement Notification Logic** - Trigger on state transitions (running → idle, idle → stopped)
4. **Add Dismissal State** - Track which notifications user has seen
5. **Optional: expo-notifications** - For background/push notifications (requires package install)
6. **Optional: WebSocket** - For real-time updates instead of 15s polling

## Relevant Code Snippets

### Agent State Detection Logic
```typescript
// agent/agents.ts:139-155
export function detectAgentState(
  sessionName: string,
  lines: string[] | null | undefined,
  processActive: boolean,
  idleWindowMs: number = IDLE_STOP_MS
): 'running' | 'idle' | 'stopped' {
  if (!processActive) return 'stopped';
  const now = Date.now();
  const hash = stablePreviewHash(lines);
  const previous = sessionActivity.get(sessionName);
  if (!previous || previous.hash !== hash) {
    sessionActivity.set(sessionName, { hash, lastChangedAt: now });
    return 'running';
  }
  const elapsed = now - previous.lastChangedAt;
  return elapsed > idleWindowMs ? 'idle' : 'running';
}
```

### Session Insights Integration
```typescript
// agent/agents.ts:157-173
export async function getSessionInsights(name: string, preview?: string[]) {
  const usage = await getUsageSnapshot();
  const agentInfo = await getSessionAgentInfo(name);
  const git = await getGitStatus(agentInfo.cwd);
  const previewLines = preview ?? (await capturePane(name, 4));
  const agentState = detectAgentState(name, previewLines, agentInfo.processActive);
  return {
    ...usage,
    git,
    meta: {
      ...(usage.meta || {}),
      activeAgent: agentInfo.agent,
      agentState,
      agentCommand: agentInfo.command,
    },
  };
}
```

### Frontend Polling
```typescript
// app/index.tsx:39-72
const { data: queryData, refetch: refetchSessions } = useQuery({
  queryKey: ['home-sessions', hosts.map((h) => h.id).join(',')],
  queryFn: async () => {
    const hostSessions = await getSessions(host, { 
      preview: true, 
      previewLines: 6, 
      insights: true 
    });
    return { sessions: allSessions, statusMap };
  },
  enabled: ready && hosts.length > 0,
  staleTime: 15_000,
  refetchInterval: 15_000,
});
```

### UI Rendering
```typescript
// app/index.tsx:371-377
const agentState = session.insights?.meta?.agentState ?? 'stopped';
const stateLabel = agentState === 'running' ? 'Running' 
                 : agentState === 'idle' ? 'Idle' 
                 : 'Stopped';
const stateTone = agentState === 'running' ? 'accent' 
                : agentState === 'idle' ? 'clay' 
                : 'muted';
```
