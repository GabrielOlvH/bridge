# Codebase Exploration Report: Tmux Dock Mobile App
Generated: 2026-01-17

## Summary

**Tmux Dock** is a React Native/Expo mobile app for managing tmux sessions across multiple remote hosts. Users can monitor, create, kill, and attach to tmux sessions on various servers (home lab, cloud VMs, etc.) through a unified mobile interface. The app connects to lightweight Node.js agents running on each host.

## Domain Model

### Core Concepts

| Concept | Description | Key Properties |
|---------|-------------|----------------|
| **Host** | A remote server running the tmux agent | name, baseUrl, authToken, SSH config, connection type (ssh/mosh) |
| **Session** | A tmux session on a host | name, windows count, attached status, preview, insights |
| **Keybind** | Quick-send tmux key sequences | label, keys array, color |
| **Agent** | Node.js server on each host exposing REST API | WebSocket terminal, session management endpoints |
| **Insights** | AI provider usage tracking | Codex, Claude, Copilot, Cursor usage + git status |

### Types (from `/home/gabrielolv/Documents/Projects/ter/lib/types.ts`)

```typescript
// Primary entities
type Host = {
  id: string;
  name: string;
  baseUrl: string;              // http://192.168.1.12:4020
  authToken?: string;            // Bearer token
  username?: string;             // SSH username
  sshHost?: string;              // SSH host override
  sshPort?: number;              // SSH port (default 22)
  identityFile?: string;         // SSH key path
  connection: 'ssh' | 'mosh';    // Connection method
  color?: string;                // UI accent color
  lastSeen?: number;             // Last successful ping timestamp
};

type Session = {
  name: string;
  windows: number;
  attached: boolean;
  createdAt?: number;
  lastAttached?: number;
  preview?: string[];            // Terminal output lines
  insights?: SessionInsights;    // AI usage tracking
};

type Keybind = {
  id: string;
  label: string;                 // "Previous Window"
  keys: string[];                // ["C-b", "p"]
  color?: string;
};

// Extended insights
type SessionInsights = {
  codex?: ProviderUsage;         // Codex AI usage
  claude?: ProviderUsage;        // Claude AI usage
  copilot?: ProviderUsage;       // GitHub Copilot usage
  cursor?: ProviderUsage;        // Cursor AI usage
  git?: GitStatus;               // Git repo status
  meta?: InsightsMeta;           // Polling metadata
};
```

## Project Structure

```
ter/
├── app/                        # Expo Router screens
│   ├── index.tsx               # Home screen (all sessions across hosts)
│   ├── keybinds.tsx            # Keybind management screen
│   ├── _layout.tsx             # Root navigation layout
│   ├── hosts/
│   │   ├── index.tsx           # Hosts list screen
│   │   ├── new.tsx             # Add new host form
│   │   └── [id]/
│   │       ├── index.tsx       # Host detail + sessions list
│   │       └── edit.tsx        # Edit host form
│   └── session/
│       └── [hostId]/[name]/
│           ├── index.tsx       # Session detail + SSH commands
│           └── terminal.tsx    # WebView terminal (xterm.js)
│
├── components/                 # Reusable UI components
│   ├── AppText.tsx             # Styled text with variants
│   ├── Screen.tsx              # SafeAreaView + gradient background
│   ├── Field.tsx               # Labeled TextInput
│   ├── HostForm.tsx            # Multi-field host configuration form
│   ├── HostCard.tsx            # Host list item
│   ├── Pill.tsx                # Tag/badge component
│   ├── SectionHeader.tsx       # Section title
│   ├── FadeIn.tsx              # Animated fade-in wrapper
│   └── icons/                  # Custom SVG icons
│
├── lib/                        # Core logic
│   ├── types.ts                # TypeScript type definitions
│   ├── api.ts                  # Agent HTTP client (fetch-based)
│   ├── store.tsx               # Global state (Context API + AsyncStorage)
│   ├── storage.ts              # AsyncStorage persistence helpers
│   ├── commands.ts             # SSH/mosh command builders
│   ├── theme.ts                # Color palette + navigation theme
│   ├── ansi.ts                 # ANSI escape code parser/stripper
│   ├── query.tsx               # TanStack Query provider
│   └── defaults.ts             # Default keybinds + ID generator
│
├── agent/                      # Node.js tmux agent (runs on hosts)
│   ├── server.js               # Hono HTTP server + WebSocket
│   ├── tmux.js                 # tmux CLI wrapper
│   ├── sessions.js             # Session parsing
│   ├── agents.js               # AI provider usage tracking
│   ├── usage.js                # Usage snapshot aggregation
│   ├── pty.js                  # Pseudoterminal helpers
│   ├── claude.js               # Claude API usage scraper
│   ├── codex.js                # Codex usage scraper
│   ├── copilot.js              # Copilot usage scraper
│   ├── cursor.js               # Cursor usage scraper
│   └── git.js                  # Git status detection
│
└── constants/                  # App-level constants
```

## App Architecture

### Navigation Flow (Expo Router)

```
/                               → Home (all sessions)
├── /hosts                      → Hosts list
│   ├── /hosts/new              → Add host
│   └── /hosts/[id]             → Host detail
│       └── /hosts/[id]/edit    → Edit host
├── /keybinds                   → Keybind management
└── /session/[hostId]/[name]    → Session detail
    └── .../terminal            → Full terminal view
```

### State Management

**Global State** (`lib/store.tsx`):
- Context API + React hooks
- Persisted to AsyncStorage
- Manages: `hosts[]`, `keybinds[]`

**Server State** (TanStack Query):
- Auto-refetch every 15-20 seconds
- Query keys:
  - `['all-sessions']` - All sessions across hosts
  - `['host-sessions', hostId]` - Sessions for one host
  - `['host-health', hostId]` - Host online/offline status

### Data Flow

```
[Mobile App] ←→ [HTTP/WS] ←→ [Agent:4020] ←→ [tmux CLI] ←→ [tmux server]
     │                              │
     └─ AsyncStorage               └─ AI usage scrapers
        (hosts, keybinds)             (claude, codex, etc.)
```

## UI Patterns

### Form Inputs

**Pattern: Labeled TextInput**
- Component: `<Field label="..." value={...} onChangeText={...} />`
- Location: `/home/gabrielolv/Documents/Projects/ter/components/Field.tsx`
- Style: Bordered input with label above, muted placeholder

```tsx
<Field 
  label="Host name" 
  value={name} 
  onChangeText={setName} 
  placeholder="Studio, Pi, or Cloud" 
/>
```

### Multi-Field Forms

**Pattern: Controlled form with submit validation**
- Component: `<HostForm initial={...} onSubmit={...} submitLabel="..." />`
- Location: `/home/gabrielolv/Documents/Projects/ter/components/HostForm.tsx`
- Fields: name, baseUrl, authToken, username, sshHost, sshPort, identityFile, connection
- Validation: Requires name and baseUrl before enabling submit

```tsx
<HostForm
  initial={existingHost}
  onSubmit={(draft) => {
    upsertHost(draft, hostId);
    router.back();
  }}
  submitLabel="Update Host"
/>
```

### Buttons/Actions

**Pattern: Pressable with disabled state**
```tsx
<Pressable 
  style={[styles.button, !canSubmit && styles.buttonDisabled]} 
  disabled={!canSubmit} 
  onPress={handleAction}
>
  <AppText variant="subtitle">{label}</AppText>
</Pressable>
```

### Lists with Pull-to-Refresh

**Pattern: ScrollView + RefreshControl**
```tsx
<ScrollView
  refreshControl={
    <RefreshControl refreshing={isFetching} onRefresh={() => refetch()} />
  }
>
  {items.map(item => <ItemCard key={item.id} {...item} />)}
</ScrollView>
```

### User Feedback

**Patterns:**
1. **Alert dialogs** - `Alert.alert(title, message, buttons)`
2. **Loading states** - `isFetching` boolean from TanStack Query
3. **Empty states** - Conditional rendering when array is empty
4. **Error display** - Show error message in UI when fetch fails

Example:
```tsx
const { data, isFetching, error } = useQuery({...});

if (error) return <AppText>Failed: {error.message}</AppText>;
if (isFetching) return <AppText>Loading...</AppText>;
if (data.length === 0) return <AppText>No sessions found</AppText>;
```

## External Process Handling

### Agent Communication

**REST API** (`lib/api.ts`):
- All communication via `fetch()` with timeout (6-12 seconds)
- Bearer token authentication (optional)
- Endpoints:
  - `GET /health` - Check if agent is alive
  - `GET /sessions?preview=1&insights=1` - List sessions
  - `POST /sessions` - Create session
  - `POST /sessions/:name/rename` - Rename
  - `POST /sessions/:name/kill` - Terminate
  - `POST /sessions/:name/keys` - Send key sequences
  - `GET /sessions/:name/capture` - Get terminal output

**WebSocket Terminal** (`app/session/[hostId]/[name]/terminal.tsx`):
- Uses `react-native-webview` to load xterm.js from CDN
- Connects to `ws://host:4020/ws?session=name&cols=80&rows=24`
- Bidirectional: keyboard input → agent → tmux, tmux output → agent → WebView

### SSH Command Generation

**Pattern: Build mosh/ssh commands for external terminal**
- Location: `/home/gabrielolv/Documents/Projects/ter/lib/commands.ts`
- Functions:
  - `buildAttachCommand(host, session)` → `mosh user@host -- tmux attach -t name`
  - `buildNewAttachCommand(host, session)` → `mosh ... -- tmux new -A -s name`
- User copies command to clipboard, pastes in terminal app

```tsx
import * as Clipboard from 'expo-clipboard';

const command = buildAttachCommand(host, sessionName);
await Clipboard.setStringAsync(command);
Alert.alert('Copied', 'Paste in your terminal app');
```

## Existing "Host" Concept

### Current Implementation

Hosts represent remote servers. Key aspects:

1. **Persistence**: Stored in AsyncStorage via `lib/storage.ts`
2. **Management**:
   - Create: `/hosts/new` screen
   - Edit: `/hosts/[id]/edit` screen
   - Delete: Swipe action (not visible in code sample but likely in HostCard)
3. **Health Checks**: Periodic `GET /health` pings to determine online/offline status
4. **UI Colors**: Each host gets a unique accent color for visual distinction

### Host Operations (from `lib/store.tsx`)

```typescript
// Store provides these host operations:
upsertHost(draft: HostDraft, id?: string) → Promise<Host>
removeHost(id: string) → Promise<void>
updateHostLastSeen(id: string, timestamp: number) → void
```

### Multi-Host Session View

**Home Screen** (`/app/index.tsx`):
- Queries all hosts in parallel
- Aggregates sessions from online hosts
- Sorts by last attached time
- Shows usage insights (AI provider quotas) per host
- Allows creating new sessions on any online host

## Questions Answered

### Q1: What is this app about?

**Answer:** ✓ VERIFIED
A React Native mobile app for managing tmux sessions on multiple remote servers. Primary use case: Developer with multiple machines (home lab, cloud VMs) who wants to monitor and control tmux sessions from their phone.

### Q2: Current app structure?

**Answer:** ✓ VERIFIED
- **Navigation**: Expo Router (file-based routing)
- **Screens**: Home (all sessions), Hosts list, Host detail, Session detail, Terminal, Keybinds, Add/Edit forms
- **State**: Context API (hosts, keybinds) + TanStack Query (sessions, health)
- **Persistence**: AsyncStorage for hosts/keybinds, no local session cache

### Q3: UI patterns for user interactions?

**Answer:** ✓ VERIFIED

| Pattern | Component | Use Case |
|---------|-----------|----------|
| Form field | `<Field label="..." />` | Single text input |
| Multi-field form | `<HostForm />` | Host configuration |
| Submit button | `<Pressable disabled={!valid}>` | Form submission |
| Lists | `ScrollView + map()` | Sessions, hosts |
| Refresh | `RefreshControl` | Pull-to-reload |
| Alerts | `Alert.alert()` | Confirmations, errors |
| Navigation | `router.push()`, `router.back()` | Screen transitions |
| Loading | `isFetching` boolean | Show spinners |

### Q4: How does the app handle external processes?

**Answer:** ✓ VERIFIED

1. **Agent REST API**: All tmux operations via HTTP (fetch with timeout)
2. **WebSocket Terminal**: Full terminal in WebView using xterm.js
3. **SSH Command Generation**: Builds `mosh`/`ssh` commands for clipboard copy (user runs in external terminal app)

No direct process spawning - all external interaction is via network or clipboard.

### Q5: Existing "project" or "host" concepts?

**Answer:** ✓ VERIFIED

**"Host" exists** - represents a remote server:
- Stored in global state (`useStore().hosts`)
- Persisted in AsyncStorage
- CRUD operations: add, edit, delete
- Health monitoring: periodic ping to check online/offline
- Visual identity: unique color per host

**No "project" concept exists** - sessions are organized only by host. Sessions are flat lists, no grouping or tagging beyond host association.

## Key Files Reference

| File | Purpose | Entry Points |
|------|---------|--------------|
| `/home/gabrielolv/Documents/Projects/ter/lib/types.ts` | Type definitions | `Host`, `Session`, `Keybind`, `SessionInsights` |
| `/home/gabrielolv/Documents/Projects/ter/lib/store.tsx` | Global state | `useStore()`, `StoreProvider` |
| `/home/gabrielolv/Documents/Projects/ter/lib/api.ts` | Agent HTTP client | `getSessions()`, `createSession()`, `killSession()` |
| `/home/gabrielolv/Documents/Projects/ter/components/Field.tsx` | Text input | `<Field label="..." />` |
| `/home/gabrielolv/Documents/Projects/ter/components/HostForm.tsx` | Host config form | `<HostForm initial={...} onSubmit={...} />` |
| `/home/gabrielolv/Documents/Projects/ter/app/index.tsx` | Home screen | `HomeScreen` component |
| `/home/gabrielolv/Documents/Projects/ter/app/hosts/[id]/index.tsx` | Host detail | Session list for one host |
| `/home/gabrielolv/Documents/Projects/ter/agent/server.js` | Agent server | Hono HTTP + WebSocket |
| `/home/gabrielolv/Documents/Projects/ter/agent/tmux.js` | tmux CLI wrapper | `runTmux()`, `parseSessions()` |

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                     Mobile App (Expo)                        │
├─────────────────────────────────────────────────────────────┤
│  Screens (Expo Router)                                       │
│  ├─ Home (all sessions)                                      │
│  ├─ Hosts (manage servers)                                   │
│  ├─ Session Detail (SSH commands)                            │
│  └─ Terminal (WebView + xterm.js)                            │
├─────────────────────────────────────────────────────────────┤
│  State Management                                            │
│  ├─ Context API (hosts, keybinds) → AsyncStorage            │
│  └─ TanStack Query (sessions, health) → Agent API           │
├─────────────────────────────────────────────────────────────┤
│  UI Components                                               │
│  ├─ Field (labeled input)                                    │
│  ├─ HostForm (multi-field form)                              │
│  ├─ Screen (gradient background + SafeAreaView)              │
│  └─ Icons (custom SVG)                                       │
└─────────────────────────────────────────────────────────────┘
                         ↕ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│              Agent (Node.js on each host)                    │
├─────────────────────────────────────────────────────────────┤
│  HTTP Server (Hono)                                          │
│  ├─ GET /sessions → list sessions                            │
│  ├─ POST /sessions → create                                  │
│  ├─ POST /sessions/:name/kill → terminate                    │
│  └─ WebSocket /ws → full terminal (pty)                      │
├─────────────────────────────────────────────────────────────┤
│  Scrapers (AI usage tracking)                                │
│  ├─ claude.js → Claude API usage                             │
│  ├─ codex.js → Codex usage                                   │
│  ├─ copilot.js → Copilot usage                               │
│  ├─ cursor.js → Cursor usage                                 │
│  └─ git.js → Git status                                      │
└─────────────────────────────────────────────────────────────┘
                         ↕ spawn
┌─────────────────────────────────────────────────────────────┐
│                    tmux (local server)                       │
│  ├─ Sessions (development workspaces)                        │
│  ├─ Windows (terminals per session)                          │
│  └─ Panes (splits)                                           │
└─────────────────────────────────────────────────────────────┘
```

## Conventions Discovered

### Naming

- **Files**: camelCase for components (`HostForm.tsx`), kebab-case for routes (`[id]/edit.tsx`)
- **Components**: PascalCase (`Screen`, `Field`)
- **Functions**: camelCase (`getSessions`, `buildAttachCommand`)
- **Types**: PascalCase (`Host`, `Session`)

### File Organization

- **Screens**: `app/` directory (Expo Router convention)
- **Components**: `components/` (flat, no nesting except `/icons`)
- **Logic**: `lib/` (utilities, API, state)
- **Agent**: `agent/` (separate Node.js app)

### Styling

- **Pattern**: StyleSheet.create() at bottom of file
- **Theme**: Centralized in `lib/theme.ts` (palette, spacing, radii)
- **Colors**: Semantic names (`palette.ink`, `palette.accent`, `palette.muted`)

### Testing

No test files found in the codebase. Testing appears to be manual/exploratory.

## Open Questions

1. **Session grouping/tagging**: Would users benefit from organizing sessions beyond just host? (e.g., "work", "personal", "experiments")
2. **Offline support**: Should the app cache session lists for offline viewing?
3. **Multi-window support**: Can users attach to specific windows within a session?
4. **Keybind customization per host**: Should keybinds be host-specific or global?
